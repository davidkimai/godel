spec:
  id: SPEC-SELF-HEALING-001
  name: Swarm Self-Healing System v2
  version: 2.0.0
  status: active

description: |
  Comprehensive self-healing system for Dash v2.0 autonomous swarms.
  Automatically detects, diagnoses, and recovers from swarm failures
  to maintain 24/7 autonomous operation without human intervention.

requirements:
  - id: REQ-001
    description: Auto-detect stale swarms (>15 min no activity)
    priority: P0
    test: node scripts/swarm-health.js --check returns 'stale' for >15min silent

  - id: REQ-002
    description: Auto-restart unhealthy swarms within 30 seconds
    priority: P0
    test: restart happens within 30 sec of stale detection

  - id: REQ-003
    description: Prevent over-spawning (max 6 concurrent swarms)
    priority: P0
    test: swarm count never exceeds 6

  - id: REQ-004
    description: Log all health events for debugging
    priority: P1
    test: .dash/swarm-health.json updated on each event

  - id: REQ-005
    description: Integrate with Swarm Watchdog cron job
    priority: P1
    test: watchdog triggers health check every 2 minutes

  - id: REQ-006
    description: Provide health status API for monitoring
    priority: P2
    test: curl localhost:7373/health returns swarm status

implementation:
  files:
    - scripts/swarm-health.js
    - scripts/swarm-lifecycle.js
    - scripts/swarm-queue.js
    - scripts/self-improvement.js
    - scripts/swarm-self-healing.js
    - src/core/autonomous-state.ts

prompt_template: |
  You are building Swarm Self-Healing System v2 for Dash v2.0.

  This system automatically maintains swarm health through:
  1. Lifecycle management (30-min timeouts)
  2. Health monitoring (detect stale swarms)
  3. Concurrency limiting (max 6 swarms)
  4. Self-improvement (pattern analysis)

  Requirements (P0 = critical):
  - [P0] Auto-detect stale swarms (>15 min silent)
  - [P0] Auto-restart within 30 seconds
  - [P0] Never exceed 6 concurrent swarms
  - [P1] Log all health events to .dash/swarm-health.json
  - [P1] Integrate with Swarm Watchdog (2-min checks)
  - [P2] Provide health status API

  Current Implementation:
  - scripts/swarm-lifecycle.js: 30-min timeout, checkpoints
  - scripts/swarm-health.js: detect stale swarms
  - scripts/swarm-queue.js: max 6 concurrent
  - scripts/self-improvement.js: pattern analysis
  - scripts/swarm-self-healing.js: master controller

  Tasks:
  1. Verify all scripts exist and are functional
  2. Test stale detection (>15 min silent)
  3. Test auto-restart within 30 sec
  4. Test concurrency limiting (max 6)
  5. Verify health logging to .dash/swarm-health.json
  6. Integrate with DASH_SWARM_WATCHDOG cron

  Success Criteria:
  - [ ] Stale swarm detected in <20 seconds
  - [ ] Restart completes in <30 seconds
  - [ ] Swarm count never exceeds 6
  - [ ] All health events logged
  - [ ] Watchdog integration working

validation:
  command: npm run build && node scripts/swarm-self-healing.js --status
  coverage_threshold: 90

metadata:
  created: 2026-02-02
  author: SDD System
  tags: [self-healing, swarm, critical]
  related:
    - SWARM_HEALTH_ANALYSIS.md
    - CONTEXT_OPTIMIZATION_IDEAL.md
