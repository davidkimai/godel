version: '3.8'

services:
  godel:
    image: godel:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: godel-dev
    restart: unless-stopped
    ports:
      - "7373:7373"
    # SECURITY: Set GODEL_API_KEY in .env file, not here
    # Example: echo "GODEL_API_KEY=$(node -e "console.log('godel_live_' + require('crypto').randomBytes(32).toString('hex'))")" >> .env
    environment:
      - NODE_ENV=development
      - PORT=7373
      - GODEL_API_KEY=${GODEL_API_KEY:?Error: GODEL_API_KEY environment variable must be set}
      - DATABASE_PATH=/data/godel.db
      - LOG_LEVEL=debug
    volumes:
      - ./godel.db:/data/godel.db
      - ./logs:/app/logs
    depends_on:
      - redis
    networks:
      - godel-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7373/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  redis:
    image: redis:7-alpine
    container_name: godel-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - godel-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Optional: Admin UI
  admin-ui:
    image: godel-admin:latest
    container_name: godel-admin
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GODEL_API_URL=http://godel:7373
      - GODEL_API_KEY=${GODEL_API_KEY:?Error: GODEL_API_KEY environment variable must be set}
    depends_on:
      - godel
    networks:
      - godel-network
    profiles:
      - ui

volumes:
  redis-data:
    driver: local

networks:
  godel-network:
    driver: bridge

# Development shortcuts
# Start: docker-compose up -d
# Stop: docker-compose down
# View logs: docker-compose logs -f godel
# Restart: docker-compose restart godel
# Scale: docker-compose up -d --scale godel=3
